{% extends "layout.html" %}
{% block content %}
<h2>Send Reminders</h2>

<form method="post">
  <label>Meeting
    <select name="meeting_id" id="meeting-select" required>
      <option value="">-- Select --</option>
      {% for m in meetings %}
      <option value="{{ m.id }}" {{ 'selected' if sel_meeting == m.id }}>{{ m.title }} ({{ m.meeting_date }})</option>
      {% endfor %}
    </select>
  </label>
  <label>Recording
    <select name="recording_id" required>
      <option value="">-- Select --</option>
      {% for r in recordings %}
      <option value="{{ r.id }}" {{ 'selected' if sel_recording == r.id }}>{{ r.name }}</option>
      {% endfor %}
    </select>
  </label>
  <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
    <button type="submit" onclick="return confirm('Send calls to this meeting\'s members?')"><i data-lucide="phone-outgoing"></i> Send Calls</button>
    <button type="button" id="btn-cancel" class="outline secondary" style="display:none;" onclick="cancelCalls()"><i data-lucide="x-circle"></i> Cancel Remaining</button>
  </div>
</form>

<div id="recipients" style="margin-top:1rem;"></div>

<h3>Progress</h3>
<div id="progress">Select a meeting and click Send, or choose a meeting to view progress.</div>
<table id="progress-table" class="compact" style="display:none">
  <thead><tr><th>Member</th><th>Phone</th><th>Status</th></tr></thead>
  <tbody></tbody>
</table>

<script>
const sel = document.getElementById('meeting-select');
sel.addEventListener('change', () => { showRecipients(); poll(); });
let timer;

function showRecipients() {
  const mid = sel.value;
  const div = document.getElementById('recipients');
  if (!mid) { div.innerHTML = ''; return; }
  fetch('/api/meeting-members?meeting_id=' + mid)
    .then(r => r.json())
    .then(d => {
      function goToMembers(e) {
        e.preventDefault();
        const recId = document.querySelector('[name=recording_id]').value || '';
        window.location = '/meetings/' + mid + '?next=send&meeting_id=' + mid + '&recording_id=' + recId;
      }
      if (!d.members.length) {
        div.innerHTML = '<p><strong>No members assigned to this meeting.</strong> <a href="#" class="edit-members">Add members</a></p>';
        div.querySelector('.edit-members').addEventListener('click', goToMembers);
        return;
      }
      div.innerHTML = '<p><strong>Will call ' + d.members.length + ' member' + (d.members.length !== 1 ? 's' : '') + ':</strong> ' +
        d.members.map(m => m.name).join(', ') + ' <a href="#" class="edit-members">Edit</a></p>';
      div.querySelector('.edit-members').addEventListener('click', goToMembers);
    });
}
function poll() {
  clearInterval(timer);
  const mid = sel.value;
  if (!mid) return;
  const fn = () => {
    fetch('/api/send-progress?meeting_id=' + mid)
      .then(r => r.json())
      .then(d => {
        if (!d.total) { document.getElementById('progress').textContent = 'No calls yet.'; document.getElementById('btn-cancel').style.display = 'none'; return; }
        document.getElementById('progress').textContent =
          `Total: ${d.total} | Completed: ${d.completed} | Failed: ${d.failed} | Queued: ${d.queued}`;
        document.getElementById('btn-cancel').style.display = d.queued > 0 ? '' : 'none';
        const tb = document.querySelector('#progress-table tbody');
        tb.innerHTML = '';
        document.getElementById('progress-table').style.display = '';
        d.rows.forEach(r => {
          const cls = r.status === 'completed' ? 'badge-completed' : (r.status === 'queued' || r.status === 'initiated') ? 'badge-queued' : 'badge-failed';
          const tr = document.createElement('tr');
          const td1 = tr.appendChild(document.createElement('td'));
          td1.textContent = r.member;
          const td2 = tr.appendChild(document.createElement('td'));
          td2.textContent = r.phone;
          const td3 = tr.appendChild(document.createElement('td'));
          const span = td3.appendChild(document.createElement('span'));
          span.className = 'badge ' + cls;
          span.textContent = r.status;
          tb.appendChild(tr);
        });
      });
  };
  fn();
  timer = setInterval(fn, 3000);
}
function cancelCalls() {
  const mid = sel.value;
  if (!mid || !confirm('Cancel all remaining calls?')) return;
  const body = new URLSearchParams();
  body.append('meeting_id', mid);
  fetch('/api/cancel-calls', { method: 'POST', body: body })
    .then(r => r.json())
    .then(d => { poll(); });
}
if (sel.value) { showRecipients(); poll(); }
</script>
{% endblock %}
